name: Reusable Run Coverage Tests

on:
  workflow_call:
    inputs:
      coverage-command:
        description: 'Command to run tests with coverage'
        required: false
        default: 'ARKLEX_TEST_ENV=local pytest tests/ --cov=arklex --cov-report=term-missing --cov-report=html --cov-report=xml --no-cov-on-fail'
        type: string
      min-coverage-threshold:
        description: 'Minimum coverage percentage to pass'
        required: false
        default: '99.1'
        type: string

jobs:
  coverage-check:
    name: Run Tests and Check Coverage
    runs-on: ubuntu-latest
    env:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .

      - name: Run tests and check coverage threshold
        id: coverage-check
        shell: bash
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          MIN_COVERAGE_THRESHOLD: ${{ inputs.min-coverage-threshold }}
        run: |
          ${{ inputs.coverage-command }}

          python -c @- << 'EOF'
          import xml.etree.ElementTree as ET
          import os

          try:
              tree = ET.parse('coverage.xml')
              root = tree.getroot()
              
              # Debug: Print root attributes
              print(f'Root tag: {root.tag}')
              print(f'Root attributes: {root.attrib}')
              
              # Use line-rate for coverage calculation
              coverage = None
              if 'line-rate' in root.attrib:
                  coverage = float(root.attrib['line-rate']) * 100
                  print(f'Found line-rate: {root.attrib["line-rate"]}')
              else:
                  # Search for any element with line-rate
                  for elem in root.iter():
                      if 'line-rate' in elem.attrib:
                          coverage = float(elem.attrib['line-rate']) * 100
                          print(f'Found line-rate in {elem.tag}: {elem.attrib["line-rate"]}')
                          break
                  else:
                      print('❌ No line-rate coverage attributes found in XML')
                      print('Available attributes:', root.attrib)
                      print('Searching all elements for line-rate...')
                      for elem in root.iter():
                          if elem.attrib:
                              print(f'  {elem.tag}: {elem.attrib}')
                      exit(1)
                  
              if coverage is None:
                  print('❌ Failed to extract coverage percentage')
                  exit(1)
                  
              print(f'Coverage: {coverage:.1f}%')

              min_coverage = float(os.environ.get('MIN_COVERAGE_THRESHOLD', '${{ inputs.min-coverage-threshold }}'))
              print(f'Minimum coverage threshold: {min_coverage}%')

              if coverage < min_coverage:
                  print(f'❌ Coverage ({coverage:.1f}%) is below minimum threshold ({min_coverage}%)')
                  exit(1)
              else:
                  print(f'✅ Coverage ({coverage:.1f}%) meets minimum threshold ({min_coverage}%)')

              with open(os.environ.get('GITHUB_OUTPUT', '/dev/null'), 'a') as f:
                  f.write(f'coverage={coverage:.1f}\\n')
          except Exception as e:
              print(f'Error reading coverage data: {e}')
              import traceback
              traceback.print_exc()
              exit(1)
          EOF
