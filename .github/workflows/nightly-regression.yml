name: Nightly Regression Tests

on:
  schedule:
    # Run every night at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:  # Allow manual triggering

jobs:
  lint:
    uses: ./.github/workflows/reusable-ruff-code-linting.yml
    with:
      python-version: '3.10'
      run-on-all-files: true

  taskgraph:
    uses: ./.github/workflows/reusable-taskgraph-generation-validation.yml
    with:
      python-version: '3.10'
      config-path: './examples/test/config.json'
    secrets:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

  coverage-check:
    uses: ./.github/workflows/reusable-diff-based-test-coverage.yml
    with:
      python-version: '3.10'
      fail-under: '100'
    secrets:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      SHOPIFY_FIXED_ARGS: ${{ secrets.SHOPIFY_FIXED_ARGS }}

  summary:
    name: Nightly Regression Summary
    runs-on: ubuntu-latest
    needs: [lint, taskgraph, coverage-check]
    if: always()
    
    steps:
      - name: Generate Summary
        run: |
          echo "## Nightly Regression Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Results:" >> $GITHUB_STEP_SUMMARY
          echo "- **Lint**: ${{ needs.lint.result == 'success' && '✅ Passed' || '❌ Failed' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **TaskGraph**: ${{ needs.taskgraph.result == 'success' && '✅ Passed' || '❌ Failed' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Coverage**: ${{ needs.coverage-check.result == 'success' && '✅ Passed' || '❌ Failed' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Overall Status:" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ needs.lint.result }}" == "success" && "${{ needs.taskgraph.result }}" == "success" && "${{ needs.coverage-check.result }}" == "success" ]]; then
            echo "🎉 **All tests passed!**" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ **Some tests failed. Please review the logs above.**" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "📅 **Run Time**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "🔗 **Workflow**: [View full run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY 