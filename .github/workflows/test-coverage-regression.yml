name: Coverage Regression Check

on:
  pull_request:
    types: [labeled]

jobs:
  check-regression:
    name: Detect Coverage Regression by File
    if: github.base_ref == 'main' && github.event.label.name == 'run-coverage-regression-test'

    runs-on: ubuntu-latest

    permissions:
      pull-requests: write
      contents: read

    env:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      SHOPIFY_FIXED_ARGS: ${{ secrets.SHOPIFY_FIXED_ARGS }}

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Set up Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e '.[milvus,shopify,hubspot]' --quiet
          pip install diff-cover coverage

      - name: Run tests with coverage
        run: |
          coverage run -m pytest tests/
          coverage xml

      - name: Compare coverage with base branch
        run: |
          # diff-cover will return non-zero exit if any new lines lack coverage
          diff-cover coverage.xml --compare-branch origin/main --fail-under=100

      - name: Upload detailed diff report
        if: failure()
        run: |
          diff-cover coverage.xml --compare-branch origin/main --html-report diff_coverage.html || true

      - name: Upload HTML diff coverage report
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: diff-coverage-report
          path: diff_coverage.html
